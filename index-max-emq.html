<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/vite.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Hent Ar Brezel - French Tactical Apparel Landing Page</title>
    
    <!-- Open Graph Meta Tags -->
    <meta property="og:title" content="Hent Ar Brezel - French Tactical Apparel" />
    <meta property="og:description" content="Vêtements tactiques inspirés des unités d'élite françaises. Collection Neon Units - Qualité premium, design authentique." />
    <meta property="og:image" content="/655b4f8fbe94a9ab563f377b20e38a51_edited.jpg" />
    <meta property="og:url" content="https://hentarbrezel.com" />
    <meta property="og:type" content="website" />
    <meta property="og:site_name" content="Hent Ar Brezel" />
    
    <!-- Twitter Card Meta Tags -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="Hent Ar Brezel - French Tactical Apparel" />
    <meta name="twitter:description" content="Vêtements tactiques inspirés des unités d'élite françaises. Collection Neon Units - Qualité premium, design authentique." />
    <meta name="twitter:image" content="/655b4f8fbe94a9ab563f377b20e38a51_edited.jpg" />

    <!-- CRITICAL: Load deduplication override FIRST -->
    <script src="/pixel-dedup-override.js"></script>
    
    <!-- MAXIMUM EMQ Facebook Pixel - Extracts ALL Possible Data -->
    <script>
        // Configuration
        window.FB_CONFIG = {
            pixelId: '1452655989058364',
            capiEndpoint: 'https://capiworker.elhallaoui-mohamed1.workers.dev/',
            testEventCode: '', 
            debug: true
        };

        // SHA-256 hashing function
        async function sha256(message) {
            if (!message) return null;
            const msgBuffer = new TextEncoder().encode(message.toLowerCase().trim());
            const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        }

        // 1. CAPTURE FACEBOOK CLICK ID FROM URL
        (function captureFacebookData() {
            const urlParams = new URLSearchParams(window.location.search);
            const fbclid = urlParams.get('fbclid');
            
            if (fbclid) {
                const fbc = 'fb.1.' + Date.now() + '.' + fbclid;
                document.cookie = '_fbc=' + fbc + '; max-age=2419200; path=/; domain=.hentarbrezel.com';
                localStorage.setItem('_fbc', fbc);
                console.log('[MAX EMQ] Facebook Click ID captured');
            }

            // Also capture utm parameters for better matching
            const utmSource = urlParams.get('utm_source');
            const utmMedium = urlParams.get('utm_medium');
            const utmCampaign = urlParams.get('utm_campaign');
            
            if (utmSource) localStorage.setItem('utm_source', utmSource);
            if (utmMedium) localStorage.setItem('utm_medium', utmMedium);
            if (utmCampaign) localStorage.setItem('utm_campaign', utmCampaign);
        })();

        // 2. CREATE PERSISTENT USER ID FOR EVERY VISITOR
        function getOrCreateUserID() {
            let userId = localStorage.getItem('user_id') || 
                        localStorage.getItem('external_id') || 
                        sessionStorage.getItem('user_id');
            
            if (!userId) {
                // Create a more sophisticated user ID using multiple factors
                const browserFingerprint = [
                    navigator.userAgent,
                    navigator.language,
                    screen.width + 'x' + screen.height,
                    screen.colorDepth,
                    new Date().getTimezoneOffset(),
                    navigator.hardwareConcurrency || 'unknown',
                    navigator.platform
                ].join('|');
                
                userId = 'user_' + Date.now() + '_' + btoa(browserFingerprint).substring(0, 10);
                
                localStorage.setItem('user_id', userId);
                localStorage.setItem('external_id', userId);
                sessionStorage.setItem('user_id', userId);
                
                console.log('[MAX EMQ] User ID created with browser fingerprint');
            }
            return userId;
        }

        // 3. EXTRACT LOCATION DATA FROM BROWSER
        async function extractLocationData() {
            // Try to get location from browser API (requires HTTPS)
            if ('geolocation' in navigator) {
                navigator.geolocation.getCurrentPosition(
                    async (position) => {
                        // Store coordinates (Facebook can use these)
                        localStorage.setItem('lat', position.coords.latitude);
                        localStorage.setItem('long', position.coords.longitude);
                        console.log('[MAX EMQ] Geolocation captured');
                    },
                    (error) => {
                        console.log('[MAX EMQ] Geolocation denied, using timezone fallback');
                    }
                );
            }

            // Get timezone as location indicator
            const timezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
            if (timezone) {
                const country = timezone.split('/')[0];
                const city = timezone.split('/')[1];
                
                if (country) {
                    const countryHash = await sha256(country);
                    localStorage.setItem('user_country', country);
                    localStorage.setItem('user_country_hash', countryHash);
                }
                
                if (city) {
                    const cityHash = await sha256(city);
                    localStorage.setItem('user_city', city);
                    localStorage.setItem('user_ct', cityHash);
                    localStorage.setItem('user_city_hash', cityHash);
                }
            }

            // Detect language/locale for better matching
            const language = navigator.language || navigator.userLanguage;
            if (language) {
                localStorage.setItem('user_locale', language);
                
                // Extract country from locale (e.g., en-US -> US)
                const localeCountry = language.split('-')[1];
                if (localeCountry && !localStorage.getItem('user_country')) {
                    localStorage.setItem('user_country', localeCountry);
                }
            }
        }

        // 4. AGGRESSIVE FORM DATA CAPTURE
        function setupAggressiveDataCapture() {
            // Monitor ALL input fields, not just forms
            document.addEventListener('input', async function(e) {
                const target = e.target;
                const value = target.value.trim();
                
                if (!value || value.length < 2) return;

                // Email detection (more patterns)
                const emailPatterns = [
                    /^[^\s@]+@[^\s@]+\.[^\s@]+$/,
                    /[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}/
                ];
                
                const looksLikeEmail = emailPatterns.some(pattern => pattern.test(value));
                const fieldLooksLikeEmail = 
                    target.type === 'email' ||
                    target.name?.toLowerCase().includes('email') ||
                    target.name?.toLowerCase().includes('mail') ||
                    target.placeholder?.toLowerCase().includes('email') ||
                    target.placeholder?.toLowerCase().includes('mail') ||
                    target.id?.toLowerCase().includes('email') ||
                    target.className?.toLowerCase().includes('email');

                if ((looksLikeEmail || fieldLooksLikeEmail) && value.includes('@')) {
                    const emailHash = await sha256(value);
                    localStorage.setItem('user_email_hash', emailHash);
                    localStorage.setItem('user_email', emailHash);
                    console.log('[MAX EMQ] Email captured');
                    reinitializePixel();
                }

                // Phone detection (more patterns)
                const phonePatterns = [
                    /^[\+]?[(]?[0-9]{3}[)]?[-\s\.]?[0-9]{3}[-\s\.]?[0-9]{4,6}$/,
                    /^[0-9]{10,15}$/,
                    /^\+[1-9]\d{1,14}$/
                ];
                
                const cleanPhone = value.replace(/\D/g, '');
                const looksLikePhone = 
                    (cleanPhone.length >= 10 && cleanPhone.length <= 15) ||
                    phonePatterns.some(pattern => pattern.test(value));
                    
                const fieldLooksLikePhone = 
                    target.type === 'tel' ||
                    target.name?.toLowerCase().includes('phone') ||
                    target.name?.toLowerCase().includes('tel') ||
                    target.name?.toLowerCase().includes('mobile') ||
                    target.placeholder?.toLowerCase().includes('phone') ||
                    target.placeholder?.toLowerCase().includes('tel') ||
                    target.placeholder?.toLowerCase().includes('mobile') ||
                    target.id?.toLowerCase().includes('phone') ||
                    target.className?.toLowerCase().includes('phone');

                if (looksLikePhone || fieldLooksLikePhone) {
                    if (cleanPhone.length >= 10) {
                        const phoneHash = await sha256(cleanPhone);
                        localStorage.setItem('user_phone_hash', phoneHash);
                        localStorage.setItem('user_phone', phoneHash);
                        console.log('[MAX EMQ] Phone captured');
                        reinitializePixel();
                    }
                }

                // Name detection (expanded)
                const nameFields = ['name', 'fname', 'lname', 'firstname', 'lastname', 'prenom', 'nom'];
                const fieldName = (target.name || target.id || target.placeholder || '').toLowerCase();
                
                if (nameFields.some(n => fieldName.includes(n)) && value.length > 1) {
                    const isFirstName = fieldName.includes('first') || fieldName.includes('prenom') || fieldName.includes('fname');
                    const isLastName = fieldName.includes('last') || fieldName.includes('nom') || fieldName.includes('lname');
                    
                    if (isFirstName || (!isLastName && nameFields.some(n => fieldName === n))) {
                        const fnHash = await sha256(value);
                        localStorage.setItem('user_fn_hash', fnHash);
                        localStorage.setItem('user_fn', fnHash);
                        console.log('[MAX EMQ] First name captured');
                    }
                    
                    if (isLastName) {
                        const lnHash = await sha256(value);
                        localStorage.setItem('user_ln_hash', lnHash);
                        localStorage.setItem('user_ln', lnHash);
                        console.log('[MAX EMQ] Last name captured');
                    }
                }

                // Zip code detection
                const zipPatterns = [
                    /^[0-9]{5}(-[0-9]{4})?$/, // US
                    /^[A-Z][0-9][A-Z] ?[0-9][A-Z][0-9]$/i, // Canada
                    /^[0-9]{5}$/ // France and others
                ];
                
                if (zipPatterns.some(pattern => pattern.test(value)) ||
                    fieldName.includes('zip') || 
                    fieldName.includes('postal') ||
                    fieldName.includes('postcode')) {
                    const zipHash = await sha256(value);
                    localStorage.setItem('user_zip_hash', zipHash);
                    localStorage.setItem('user_zp', zipHash);
                    console.log('[MAX EMQ] Zip code captured');
                }

                // City detection
                if (fieldName.includes('city') || fieldName.includes('ville')) {
                    const cityHash = await sha256(value);
                    localStorage.setItem('user_city_hash', cityHash);
                    localStorage.setItem('user_ct', cityHash);
                    console.log('[MAX EMQ] City captured');
                }

                // State detection
                if (fieldName.includes('state') || fieldName.includes('province') || fieldName.includes('region')) {
                    const stateHash = await sha256(value);
                    localStorage.setItem('user_state_hash', stateHash);
                    localStorage.setItem('user_st', stateHash);
                    console.log('[MAX EMQ] State captured');
                }
            });

            // Also capture data from select dropdowns
            document.addEventListener('change', async function(e) {
                const target = e.target;
                if (target.tagName === 'SELECT') {
                    const fieldName = (target.name || target.id || '').toLowerCase();
                    const value = target.value;
                    
                    if (fieldName.includes('country') || fieldName.includes('pays')) {
                        const countryHash = await sha256(value);
                        localStorage.setItem('user_country_hash', countryHash);
                        localStorage.setItem('user_country', value);
                        console.log('[MAX EMQ] Country captured from dropdown');
                    }
                    
                    if (fieldName.includes('state') || fieldName.includes('province')) {
                        const stateHash = await sha256(value);
                        localStorage.setItem('user_state_hash', stateHash);
                        localStorage.setItem('user_st', stateHash);
                        console.log('[MAX EMQ] State captured from dropdown');
                    }

                    if (fieldName.includes('gender') || fieldName.includes('sex')) {
                        const genderHash = await sha256(value.substring(0, 1).toLowerCase());
                        localStorage.setItem('user_ge', genderHash);
                        localStorage.setItem('user_gender', genderHash);
                        console.log('[MAX EMQ] Gender captured');
                    }
                }
            });

            // Capture data from button clicks that might contain email/phone
            document.addEventListener('click', async function(e) {
                const target = e.target;
                const text = target.textContent || target.value || '';
                
                // Check if clicked element or its parent contains email
                const emailRegex = /[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}/;
                const emailMatch = text.match(emailRegex);
                if (emailMatch) {
                    const emailHash = await sha256(emailMatch[0]);
                    localStorage.setItem('user_email_hash', emailHash);
                    console.log('[MAX EMQ] Email captured from click');
                }
                
                // Check for phone numbers in clicked elements
                const phoneRegex = /[\+]?[(]?[0-9]{3}[)]?[-\s\.]?[0-9]{3}[-\s\.]?[0-9]{4,6}/;
                const phoneMatch = text.match(phoneRegex);
                if (phoneMatch) {
                    const cleanPhone = phoneMatch[0].replace(/\D/g, '');
                    if (cleanPhone.length >= 10) {
                        const phoneHash = await sha256(cleanPhone);
                        localStorage.setItem('user_phone_hash', phoneHash);
                        console.log('[MAX EMQ] Phone captured from click');
                    }
                }
            });

            // Monitor copy events (user might copy their email/phone)
            document.addEventListener('copy', async function(e) {
                const selection = window.getSelection().toString();
                
                const emailRegex = /[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}/;
                const emailMatch = selection.match(emailRegex);
                if (emailMatch) {
                    const emailHash = await sha256(emailMatch[0]);
                    localStorage.setItem('user_email_hash', emailHash);
                    console.log('[MAX EMQ] Email captured from copy');
                }
            });
        }

        // 5. GET ALL ADVANCED MATCHING DATA
        async function getAdvancedMatchingData() {
            const data = {
                em: localStorage.getItem('user_email_hash') || localStorage.getItem('user_email'),
                ph: localStorage.getItem('user_phone_hash') || localStorage.getItem('user_phone'),
                fn: localStorage.getItem('user_fn_hash') || localStorage.getItem('user_fn'),
                ln: localStorage.getItem('user_ln_hash') || localStorage.getItem('user_ln'),
                ct: localStorage.getItem('user_city_hash') || localStorage.getItem('user_ct'),
                st: localStorage.getItem('user_state_hash') || localStorage.getItem('user_st'),
                zp: localStorage.getItem('user_zip_hash') || localStorage.getItem('user_zp'),
                country: localStorage.getItem('user_country_hash') || localStorage.getItem('user_country'),
                ge: localStorage.getItem('user_ge') || localStorage.getItem('user_gender'),
                db: localStorage.getItem('user_db') || localStorage.getItem('user_dob'),
                external_id: getOrCreateUserID()
            };

            // Remove null values
            Object.keys(data).forEach(key => {
                if (!data[key]) delete data[key];
            });

            return data;
        }

        // 6. REINITIALIZE PIXEL WITH NEW DATA
        async function reinitializePixel() {
            const advancedData = await getAdvancedMatchingData();
            if (window.fbq) {
                window.fbq('init', window.FB_CONFIG.pixelId, advancedData);
                console.log('[MAX EMQ] Pixel reinitialized with data:', Object.keys(advancedData));
            }
        }

        // 7. DEDUPLICATION
        window.FB_EVENTS_SENT = new Map();
        
        function isDuplicateEvent(eventName, params) {
            const eventKey = `${eventName}_${JSON.stringify(params?.content_ids || '')}_${params?.value || ''}`;
            const lastSent = window.FB_EVENTS_SENT.get(eventKey);
            
            if (lastSent && (Date.now() - lastSent) < 5000) {
                console.warn('Duplicate event blocked:', eventName);
                return true;
            }
            
            window.FB_EVENTS_SENT.set(eventKey, Date.now());
            
            if (window.FB_EVENTS_SENT.size > 100) {
                const oldestKey = window.FB_EVENTS_SENT.keys().next().value;
                window.FB_EVENTS_SENT.delete(oldestKey);
            }
            
            return false;
        }

        // 8. LOAD FACEBOOK PIXEL
        !function(f,b,e,v,n,t,s)
        {if(f.fbq)return;n=f.fbq=function(){n.callMethod?
        n.callMethod.apply(n,arguments):n.queue.push(arguments)};
        if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
        n.queue=[];t=b.createElement(e);t.async=!0;
        t.src=v;s=b.getElementsByTagName(e)[0];
        s.parentNode.insertBefore(t,s)}(window,document,'script',
        'https://connect.facebook.net/en_US/fbevents.js');

        // 9. INITIALIZE WITH MAXIMUM DATA
        (async function initializeMaxEMQPixel() {
            // Create user ID immediately
            const userId = getOrCreateUserID();
            
            // Extract location data
            await extractLocationData();
            
            // Get all available matching data
            const advancedData = await getAdvancedMatchingData();
            
            // Initialize pixel with all data
            fbq('init', window.FB_CONFIG.pixelId, advancedData);
            
            // Enable ALL automatic features
            fbq('set', 'autoConfig', 'true', window.FB_CONFIG.pixelId);
            
            // Track PageView with extra data
            fbq('track', 'PageView', {
                referrer: document.referrer,
                user_agent: navigator.userAgent,
                screen_size: screen.width + 'x' + screen.height,
                viewport_size: window.innerWidth + 'x' + window.innerHeight
            });
            
            console.log('[MAX EMQ] Maximum EMQ Pixel initialized');
            console.log('[MAX EMQ] Initial data available:', Object.keys(advancedData));
            
            // Setup aggressive data capture
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', setupAggressiveDataCapture);
            } else {
                setupAggressiveDataCapture();
            }
            
            // Log EMQ status after 2 seconds
            setTimeout(() => {
                console.log('[MAX EMQ] Data collection status:');
                console.log('- User ID:', !!localStorage.getItem('user_id') ? '✅' : '❌');
                console.log('- Email:', !!localStorage.getItem('user_email_hash') ? '✅' : '❌');
                console.log('- Phone:', !!localStorage.getItem('user_phone_hash') ? '✅' : '❌');
                console.log('- _fbp:', !!getCookie('_fbp') ? '✅' : '❌');
                console.log('- _fbc:', !!(getCookie('_fbc') || localStorage.getItem('_fbc')) ? '✅' : '❌');
                console.log('- Location:', !!localStorage.getItem('user_country') ? '✅' : '❌');
                console.log('- Names:', !!localStorage.getItem('user_fn_hash') ? '✅' : '❌');
            }, 2000);
        })();

        // 10. ENHANCED CAPI WITH MAXIMUM DATA
        async function sendToCAPI(eventName, parameters = {}) {
            if (!window.FB_CONFIG.capiEndpoint) return;
            
            try {
                const advancedData = await getAdvancedMatchingData();
                
                const payload = {
                    event_name: eventName,
                    event_time: Math.floor(Date.now() / 1000),
                    event_id: parameters.eventID || (Date.now().toString(36) + Math.random().toString(36).substring(2, 9)),
                    action_source: 'website',
                    event_source_url: window.location.href,
                    user_data: {
                        ...advancedData,
                        client_ip_address: 'auto',
                        client_user_agent: navigator.userAgent,
                        fbc: getCookie('_fbc') || localStorage.getItem('_fbc'),
                        fbp: getCookie('_fbp') || localStorage.getItem('_fbp')
                    },
                    custom_data: parameters
                };
                
                // Remove empty values
                Object.keys(payload.user_data).forEach(key => {
                    if (!payload.user_data[key]) delete payload.user_data[key];
                });
                
                if (window.FB_CONFIG.testEventCode) {
                    payload.test_event_code = window.FB_CONFIG.testEventCode;
                }
                
                const response = await fetch(window.FB_CONFIG.capiEndpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(payload)
                });
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('CAPI Response:', result);
                }
            } catch (error) {
                console.error('CAPI Error:', error);
            }
        }

        // Helper function to get cookie
        function getCookie(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return parts.pop().split(';').shift();
            return null;
        }

        // Wrap fbq to add CAPI
        const originalFbq = window.fbq;
        window.fbq = function() {
            const [command, eventName, params] = arguments;
            
            if (command === 'track' || command === 'trackCustom') {
                if (isDuplicateEvent(eventName, params)) {
                    return;
                }
                
                if (params && !params.eventID) {
                    params.eventID = Date.now().toString(36) + Math.random().toString(36).substring(2, 9);
                }
                
                if (eventName !== 'PageView') {
                    sendToCAPI(eventName, params);
                }
            }
            
            return originalFbq.apply(this, arguments);
        };
        
        Object.keys(originalFbq).forEach(key => {
            window.fbq[key] = originalFbq[key];
        });
    </script>
</head>
<body>
  <div id="root"></div>
  <script type="module" src="/src/main.jsx"></script>
</body>
</html>