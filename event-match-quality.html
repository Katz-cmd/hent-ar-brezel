<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Facebook Event Match Quality Checker</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f0f2f5;
            padding: 20px;
            color: #1c1e21;
        }
        
        .container {
            max-width: 900px;
            margin: 0 auto;
        }
        
        h1 {
            font-size: 24px;
            margin-bottom: 20px;
            color: #1877f2;
        }
        
        .emq-score {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        
        .score-display {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .score-circle {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }
        
        .score-number {
            font-size: 36px;
        }
        
        .score-label {
            font-size: 14px;
        }
        
        .score-poor { background: #e74c3c; }
        .score-fair { background: #f39c12; }
        .score-good { background: #3498db; }
        .score-great { background: #27ae60; }
        .score-excellent { background: #16a085; }
        
        .score-details h3 {
            margin-bottom: 10px;
            font-size: 18px;
        }
        
        .parameters-grid {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        
        .param-category {
            margin-bottom: 20px;
        }
        
        .param-category h3 {
            font-size: 16px;
            margin-bottom: 12px;
            color: #1877f2;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .params-list {
            display: grid;
            gap: 8px;
        }
        
        .param-item {
            display: flex;
            align-items: center;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 6px;
            border-left: 4px solid #dee2e6;
        }
        
        .param-item.present {
            background: #d4edda;
            border-left-color: #28a745;
        }
        
        .param-item.missing {
            background: #f8d7da;
            border-left-color: #dc3545;
        }
        
        .param-item.warning {
            background: #fff3cd;
            border-left-color: #ffc107;
        }
        
        .param-name {
            flex: 1;
            font-weight: 500;
        }
        
        .param-value {
            font-size: 12px;
            color: #6c757d;
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .param-status {
            margin-left: 10px;
            font-size: 20px;
        }
        
        .impact-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            margin-left: 8px;
        }
        
        .impact-high {
            background: #dc3545;
            color: white;
        }
        
        .impact-medium {
            background: #ffc107;
            color: #000;
        }
        
        .impact-low {
            background: #6c757d;
            color: white;
        }
        
        .recommendations {
            background: #e3f2fd;
            border-left: 4px solid #1877f2;
            padding: 15px;
            margin-top: 20px;
            border-radius: 4px;
        }
        
        .recommendations h4 {
            margin-bottom: 10px;
            color: #1877f2;
        }
        
        .recommendations ul {
            margin-left: 20px;
        }
        
        .recommendations li {
            margin-bottom: 5px;
        }
        
        .test-section {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        
        .test-form {
            display: grid;
            gap: 10px;
            margin-top: 15px;
        }
        
        .test-form input {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        .test-form button {
            padding: 10px 20px;
            background: #1877f2;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
        }
        
        .test-form button:hover {
            background: #166fe5;
        }
        
        .info-box {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 15px;
            font-size: 14px;
        }
        
        .category-score {
            float: right;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üìä Facebook Event Match Quality (EMQ) Checker</h1>
        
        <div class="emq-score">
            <div class="score-display">
                <div id="scoreCircle" class="score-circle score-poor">
                    <div class="score-number" id="scoreValue">0.0</div>
                    <div class="score-label">out of 10</div>
                </div>
                <div class="score-details">
                    <h3>Event Match Quality Score</h3>
                    <p id="scoreDescription">Checking your implementation...</p>
                    <p style="margin-top: 10px; color: #6c757d;">
                        Facebook's EMQ score indicates how well your events can be matched to Facebook accounts.
                        Target: 7.0+ for good performance, 8.5+ for excellent.
                    </p>
                </div>
            </div>
        </div>
        
        <div class="parameters-grid">
            <h2 style="margin-bottom: 20px;">Customer Information Parameters</h2>
            
            <!-- Critical Parameters (Highest Impact) -->
            <div class="param-category">
                <h3>
                    üî¥ Critical Parameters 
                    <span class="impact-badge impact-high">HIGH IMPACT</span>
                    <span class="category-score" id="criticalScore">0/5</span>
                </h3>
                <div class="params-list" id="criticalParams">
                    <div class="param-item missing" data-param="email">
                        <span class="param-name">Email (em)</span>
                        <span class="param-value">Not detected</span>
                        <span class="param-status">‚ùå</span>
                    </div>
                    <div class="param-item missing" data-param="phone">
                        <span class="param-name">Phone (ph)</span>
                        <span class="param-value">Not detected</span>
                        <span class="param-status">‚ùå</span>
                    </div>
                    <div class="param-item missing" data-param="fbp">
                        <span class="param-name">Facebook Browser ID (_fbp)</span>
                        <span class="param-value">Not detected</span>
                        <span class="param-status">‚ùå</span>
                    </div>
                    <div class="param-item missing" data-param="fbc">
                        <span class="param-name">Facebook Click ID (_fbc)</span>
                        <span class="param-value">Not detected</span>
                        <span class="param-status">‚ùå</span>
                    </div>
                    <div class="param-item missing" data-param="external_id">
                        <span class="param-name">External ID (User ID)</span>
                        <span class="param-value">Not detected</span>
                        <span class="param-status">‚ùå</span>
                    </div>
                </div>
            </div>
            
            <!-- Important Parameters (Medium Impact) -->
            <div class="param-category">
                <h3>
                    üü° Important Parameters
                    <span class="impact-badge impact-medium">MEDIUM IMPACT</span>
                    <span class="category-score" id="importantScore">0/5</span>
                </h3>
                <div class="params-list" id="importantParams">
                    <div class="param-item missing" data-param="fn">
                        <span class="param-name">First Name (fn)</span>
                        <span class="param-value">Not detected</span>
                        <span class="param-status">‚ùå</span>
                    </div>
                    <div class="param-item missing" data-param="ln">
                        <span class="param-name">Last Name (ln)</span>
                        <span class="param-value">Not detected</span>
                        <span class="param-status">‚ùå</span>
                    </div>
                    <div class="param-item missing" data-param="ge">
                        <span class="param-name">Gender (ge)</span>
                        <span class="param-value">Not detected</span>
                        <span class="param-status">‚ùå</span>
                    </div>
                    <div class="param-item missing" data-param="db">
                        <span class="param-name">Date of Birth (db)</span>
                        <span class="param-value">Not detected</span>
                        <span class="param-status">‚ùå</span>
                    </div>
                    <div class="param-item missing" data-param="client_ip">
                        <span class="param-name">Client IP Address</span>
                        <span class="param-value">Not detected</span>
                        <span class="param-status">‚ùå</span>
                    </div>
                </div>
            </div>
            
            <!-- Additional Parameters (Low Impact) -->
            <div class="param-category">
                <h3>
                    üîµ Additional Parameters
                    <span class="impact-badge impact-low">LOW IMPACT</span>
                    <span class="category-score" id="additionalScore">0/5</span>
                </h3>
                <div class="params-list" id="additionalParams">
                    <div class="param-item missing" data-param="ct">
                        <span class="param-name">City (ct)</span>
                        <span class="param-value">Not detected</span>
                        <span class="param-status">‚ùå</span>
                    </div>
                    <div class="param-item missing" data-param="st">
                        <span class="param-name">State (st)</span>
                        <span class="param-value">Not detected</span>
                        <span class="param-status">‚ùå</span>
                    </div>
                    <div class="param-item missing" data-param="zp">
                        <span class="param-name">Zip Code (zp)</span>
                        <span class="param-value">Not detected</span>
                        <span class="param-status">‚ùå</span>
                    </div>
                    <div class="param-item missing" data-param="country">
                        <span class="param-name">Country (country)</span>
                        <span class="param-value">Not detected</span>
                        <span class="param-status">‚ùå</span>
                    </div>
                    <div class="param-item missing" data-param="client_user_agent">
                        <span class="param-name">User Agent</span>
                        <span class="param-value">Not detected</span>
                        <span class="param-status">‚ùå</span>
                    </div>
                </div>
            </div>
            
            <div class="recommendations" id="recommendations">
                <h4>üìà Recommendations to Improve EMQ</h4>
                <ul id="recommendationsList">
                    <li>Checking your implementation...</li>
                </ul>
            </div>
        </div>
        
        <div class="test-section">
            <h3>üß™ Test User Data Collection</h3>
            <div class="info-box">
                Add test user data to see how it affects your EMQ score. Data is hashed before storage (SHA-256).
            </div>
            <div class="test-form">
                <input type="email" id="testEmail" placeholder="Email address">
                <input type="tel" id="testPhone" placeholder="Phone number (with country code)">
                <input type="text" id="testFirstName" placeholder="First name">
                <input type="text" id="testLastName" placeholder="Last name">
                <input type="text" id="testUserId" placeholder="User ID">
                <button onclick="setTestData()">Set Test Data & Recalculate</button>
                <button onclick="clearTestData()" style="background: #6c757d;">Clear All Data</button>
            </div>
        </div>
    </div>
    
    <script>
        // Helper to get cookie
        function getCookie(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return parts.pop().split(';').shift();
            return null;
        }
        
        // SHA-256 hashing
        async function sha256(message) {
            const msgBuffer = new TextEncoder().encode(message);
            const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        }
        
        // Check all parameters
        function checkParameters() {
            const params = {
                // Critical
                email: localStorage.getItem('user_email') || localStorage.getItem('user_email_hash'),
                phone: localStorage.getItem('user_phone') || localStorage.getItem('user_phone_hash'),
                fbp: getCookie('_fbp') || localStorage.getItem('_fbp'),
                fbc: getCookie('_fbc') || localStorage.getItem('_fbc'),
                external_id: localStorage.getItem('user_id') || localStorage.getItem('external_id'),
                
                // Important
                fn: localStorage.getItem('user_fn') || localStorage.getItem('user_first_name'),
                ln: localStorage.getItem('user_ln') || localStorage.getItem('user_last_name'),
                ge: localStorage.getItem('user_ge') || localStorage.getItem('user_gender'),
                db: localStorage.getItem('user_db') || localStorage.getItem('user_dob'),
                client_ip: 'Auto-detected by CAPI',
                
                // Additional
                ct: localStorage.getItem('user_ct') || localStorage.getItem('user_city'),
                st: localStorage.getItem('user_st') || localStorage.getItem('user_state'),
                zp: localStorage.getItem('user_zp') || localStorage.getItem('user_zip'),
                country: localStorage.getItem('user_country'),
                client_user_agent: navigator.userAgent
            };
            
            return params;
        }
        
        // Update parameter display
        function updateParameterDisplay(paramId, value) {
            const element = document.querySelector(`[data-param="${paramId}"]`);
            if (!element) return;
            
            const valueEl = element.querySelector('.param-value');
            const statusEl = element.querySelector('.param-status');
            
            if (value && value !== 'Not detected') {
                element.className = 'param-item present';
                valueEl.textContent = value.substring(0, 20) + (value.length > 20 ? '...' : '');
                statusEl.textContent = '‚úÖ';
            } else {
                element.className = 'param-item missing';
                valueEl.textContent = 'Not detected';
                statusEl.textContent = '‚ùå';
            }
        }
        
        // Calculate EMQ score
        function calculateEMQScore(params) {
            let score = 0;
            let criticalCount = 0;
            let importantCount = 0;
            let additionalCount = 0;
            
            // Critical parameters (worth 1.5 points each, max 7.5)
            const critical = ['email', 'phone', 'fbp', 'fbc', 'external_id'];
            critical.forEach(param => {
                if (params[param]) {
                    score += 1.5;
                    criticalCount++;
                }
            });
            
            // Important parameters (worth 0.4 points each, max 2)
            const important = ['fn', 'ln', 'ge', 'db', 'client_ip'];
            important.forEach(param => {
                if (params[param]) {
                    score += 0.4;
                    importantCount++;
                }
            });
            
            // Additional parameters (worth 0.1 points each, max 0.5)
            const additional = ['ct', 'st', 'zp', 'country', 'client_user_agent'];
            additional.forEach(param => {
                if (params[param]) {
                    score += 0.1;
                    additionalCount++;
                }
            });
            
            // Cap at 10
            score = Math.min(10, score);
            
            // Update category scores
            document.getElementById('criticalScore').textContent = `${criticalCount}/5`;
            document.getElementById('importantScore').textContent = `${importantCount}/5`;
            document.getElementById('additionalScore').textContent = `${additionalCount}/5`;
            
            return {
                score: score.toFixed(1),
                critical: criticalCount,
                important: importantCount,
                additional: additionalCount
            };
        }
        
        // Update score display
        function updateScoreDisplay(scoreData) {
            const scoreEl = document.getElementById('scoreValue');
            const circleEl = document.getElementById('scoreCircle');
            const descEl = document.getElementById('scoreDescription');
            
            scoreEl.textContent = scoreData.score;
            
            // Update circle color based on score
            circleEl.className = 'score-circle';
            if (scoreData.score >= 8.5) {
                circleEl.classList.add('score-excellent');
                descEl.textContent = 'Excellent! Your EMQ is optimized for maximum match rate.';
            } else if (scoreData.score >= 7) {
                circleEl.classList.add('score-great');
                descEl.textContent = 'Great! Good match quality, minor improvements possible.';
            } else if (scoreData.score >= 5) {
                circleEl.classList.add('score-good');
                descEl.textContent = 'Good, but significant improvements needed for better matching.';
            } else if (scoreData.score >= 3) {
                circleEl.classList.add('score-fair');
                descEl.textContent = 'Fair. Missing critical parameters affecting match quality.';
            } else {
                circleEl.classList.add('score-poor');
                descEl.textContent = 'Poor. Most critical parameters are missing.';
            }
        }
        
        // Generate recommendations
        function generateRecommendations(params, scoreData) {
            const recommendations = [];
            
            if (!params.email) {
                recommendations.push('üî¥ Collect email addresses - This has the highest impact on EMQ');
            }
            if (!params.phone) {
                recommendations.push('üî¥ Collect phone numbers - Second highest impact parameter');
            }
            if (!params.fbp) {
                recommendations.push('üî¥ Ensure _fbp cookie is being set by Facebook Pixel');
            }
            if (!params.fbc) {
                recommendations.push('üü° Capture _fbc from Facebook ad clicks (fbclid parameter)');
            }
            if (!params.external_id) {
                recommendations.push('üü° Set external_id for logged-in users');
            }
            
            if (scoreData.critical < 3) {
                recommendations.push('‚ö†Ô∏è Focus on critical parameters first - they have the most impact');
            }
            
            if (scoreData.score >= 7) {
                recommendations.push('‚úÖ Your EMQ is good! Consider A/B testing to optimize further');
            }
            
            const listEl = document.getElementById('recommendationsList');
            listEl.innerHTML = recommendations.map(r => `<li>${r}</li>`).join('');
        }
        
        // Set test data
        async function setTestData() {
            const email = document.getElementById('testEmail').value;
            const phone = document.getElementById('testPhone').value;
            const firstName = document.getElementById('testFirstName').value;
            const lastName = document.getElementById('testLastName').value;
            const userId = document.getElementById('testUserId').value;
            
            if (email) {
                const hashedEmail = await sha256(email.toLowerCase().trim());
                localStorage.setItem('user_email_hash', hashedEmail);
                localStorage.setItem('user_email', hashedEmail);
            }
            
            if (phone) {
                const cleanPhone = phone.replace(/\D/g, '');
                const hashedPhone = await sha256(cleanPhone);
                localStorage.setItem('user_phone_hash', hashedPhone);
                localStorage.setItem('user_phone', hashedPhone);
            }
            
            if (firstName) {
                const hashedFn = await sha256(firstName.toLowerCase().trim());
                localStorage.setItem('user_fn', hashedFn);
            }
            
            if (lastName) {
                const hashedLn = await sha256(lastName.toLowerCase().trim());
                localStorage.setItem('user_ln', hashedLn);
            }
            
            if (userId) {
                localStorage.setItem('user_id', userId);
                localStorage.setItem('external_id', userId);
            }
            
            // Refresh the check
            runCheck();
        }
        
        // Clear test data
        function clearTestData() {
            const keysToRemove = [
                'user_email', 'user_email_hash',
                'user_phone', 'user_phone_hash',
                'user_fn', 'user_first_name',
                'user_ln', 'user_last_name',
                'user_id', 'external_id',
                'user_ge', 'user_gender',
                'user_db', 'user_dob',
                'user_ct', 'user_city',
                'user_st', 'user_state',
                'user_zp', 'user_zip',
                'user_country'
            ];
            
            keysToRemove.forEach(key => localStorage.removeItem(key));
            
            // Clear form
            document.getElementById('testEmail').value = '';
            document.getElementById('testPhone').value = '';
            document.getElementById('testFirstName').value = '';
            document.getElementById('testLastName').value = '';
            document.getElementById('testUserId').value = '';
            
            // Refresh
            runCheck();
        }
        
        // Main check function
        function runCheck() {
            const params = checkParameters();
            
            // Update display for each parameter
            Object.keys(params).forEach(key => {
                updateParameterDisplay(key, params[key]);
            });
            
            // Calculate score
            const scoreData = calculateEMQScore(params);
            
            // Update score display
            updateScoreDisplay(scoreData);
            
            // Generate recommendations
            generateRecommendations(params, scoreData);
        }
        
        // Run on load
        window.addEventListener('load', () => {
            runCheck();
            
            // Also check for Facebook Pixel
            if (typeof fbq === 'undefined') {
                console.warn('Facebook Pixel not detected on this page');
            }
        });
    </script>
</body>
</html>